<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Newsletter — EU Funding & Tenders</title>
<style>
  :root { --fg:#0f172a; --muted:#475569; --bg:#ffffff; --card:#f8fafc; --chip:#e2e8f0; --accent:#2563eb;}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--fg);background:var(--bg)}
  header{padding:24px 20px;border-bottom:1px solid #e5e7eb;background:#fff;position:sticky;top:0;z-index:10}
  h1{margin:0 0 8px 0;font-size:22px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .controls label{font-size:14px;color:var(--muted)}
  select,input[type="number"],input[type="text"]{padding:6px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-size:14px}
  main{padding:20px;max-width:1100px;margin:0 auto}
  section{margin:26px 0}
  h2{font-size:18px;margin:0 0 10px 0}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:14px;display:flex;flex-direction:column}
  .kpis{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0 0}
  .chip{background:var(--chip);color:#0f172a;border-radius:999px;padding:4px 8px;font-size:12px}
  .title{font-weight:600;margin:0 0 6px 0;font-size:15px}
  .muted{color:var(--muted);font-size:13px}
  .link{margin-top:auto}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  .empty{color:var(--muted);font-style:italic;padding:10px 0}
  footer{padding:20px;color:var(--muted);font-size:12px;text-align:center;border-top:1px solid #e5e7eb;margin-top:20px}
</style>
</head>
<body>
<header>
  <h1>EU Funding & Tenders — Sélection</h1>
  <div class="controls">
    <label>Fenêtre (jours jusqu’à deadline) :
      <select id="daysWindow">
        <option value="14" selected>≤ 14 jours</option>
        <option value="30">≤ 30 jours</option>
        <option value="45">≤ 45 jours</option>
        <option value="90">≤ 90 jours</option>
        <option value="9999">Toutes</option>
      </select>
    </label>
    <label>Mots-clés (Funding) :
      <input id="kw" type="text" placeholder="ex: AI, energy, health…" size="28">
    </label>
    <label>Pays acheteur (Tenders) :
      <input id="country" type="text" placeholder="ex: France, Germany…" size="18">
    </label>
    <label>Min. valeur estimée (Tenders, €) :
      <input id="minVal" type="number" min="0" step="1000" placeholder="1000000" style="width:130px">
    </label>
    <button id="apply" style="margin-left:8px;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer">Appliquer</button>
  </div>
</header>

<main>
  <section id="funding">
    <h2>Funding — prochaines échéances</h2>
    <div class="grid" id="fundingGrid"></div>
    <div class="empty" id="fundingEmpty" hidden>Aucun résultat pour les filtres choisis.</div>
  </section>

  <section id="tenders">
    <h2>Tenders — prochaines échéances</h2>
    <div class="grid" id="tendersGrid"></div>
    <div class="empty" id="tendersEmpty" hidden>Aucun résultat pour les filtres choisis.</div>
  </section>

  <section id="news">
    <h2>Nouveautés de la semaine</h2>
    <div class="grid" id="newsGrid"></div>
    <div class="empty" id="newsEmpty" hidden>Rien de nouveau sur les 7 derniers jours.</div>
  </section>
</main>

<footer>
  Généré côté client à partir de <code>funding_enriched.csv</code> et <code>tenders_enriched.csv</code> (docs/). Dernière maj : <span id="ts">–</span>
</footer>

<script>
/* ====== utilitaires ====== */
const parseCSV = (text) => {
  // Petit parseur CSV qui gère les quotes
  const rows = []; let i = 0, cur = [], cell = '', inQ = false;
  while (i < text.length) {
    const c = text[i];
    if (inQ) {
      if (c === '"') {
        if (text[i+1] === '"') { cell += '"'; i+=2; continue; }
        inQ = false; i++; continue;
      }
      cell += c; i++; continue;
    } else {
      if (c === '"') { inQ = true; i++; continue; }
      if (c === ',') { cur.push(cell); cell=''; i++; continue; }
      if (c === '\n' || c === '\r') {
        if (c === '\r' && text[i+1] === '\n') i++;
        cur.push(cell); rows.push(cur); cur=[]; cell=''; i++; continue;
      }
      cell += c; i++; continue;
    }
  }
  if (cell.length || cur.length) { cur.push(cell); rows.push(cur); }
  const header = rows.shift();
  return rows.filter(r => r.length===header.length).map(r => Object.fromEntries(header.map((h,j)=>[h, r[j]])));
};
const byNum = v => {
  if (v === '' || v == null) return null;
  const n = Number(String(v).replace(/\s/g,''));
  return isNaN(n) ? null : n;
};
const daysTo = iso => {
  if (!iso) return null;
  const d = new Date(iso); if (isNaN(d)) return null;
  const now = new Date();
  return Math.ceil((d - now)/(1000*60*60*24));
};
const withinDays = (iso, max) => {
  const d = daysTo(iso);
  if (d === null) return false;
  return d <= max;
};
const includesAnyKw = (text, kws) => {
  if (!kws.length) return true;
  const s = (text||'').toLowerCase();
  return kws.some(k => s.includes(k.toLowerCase()));
};
const thisWeek = (isoTs) => {
  if (!isoTs) return false;
  const d = new Date(isoTs); if (isNaN(d)) return false;
  const now = new Date();
  return (now - d) <= 7*24*3600*1000;
};
const esc = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));

/* ====== rendu cartes ====== */
function cardFunding(x){
  const dl = x.nextDeadline || '';
  const days = daysTo(dl);
  const chips = [];
  if (x.programme) chips.push(esc(x.programme));
  if (x.typeOfAction) chips.push(esc(x.typeOfAction));
  if (x.destination) chips.push(esc(x.destination));
  if (x.priorityScore!=='' && x.priorityScore!=null) chips.push('Score '+esc(x.priorityScore));
  return `
    <div class="card">
      <div class="title">${esc(x.title || x.identifier)}</div>
      <div class="muted">${esc(x.identifier || '')}</div>
      <div class="muted">${dl ? 'Prochaine deadline : '+esc(dl)+ (days!=null ? ' ('+days+' j)' : '') : 'Deadline : n/a'}</div>
      ${x.summaryShort ? `<div class="muted" style="margin-top:6px">${esc(x.summaryShort)}</div>` : ''}
      <div class="kpis">${chips.map(c=>`<span class="chip">${c}</span>`).join('')}</div>
      <div class="link" style="margin-top:10px"><a href="${esc(x.url)}" target="_blank" rel="noopener">Voir le topic</a>${x.callUrl ? ` • <a href="${esc(x.callUrl)}" target="_blank" rel="noopener">Call</a>`:''}</div>
    </div>`;
}
function cardTender(x){
  const dl = x.deadlineDate || '';
  const days = daysTo(dl);
  const chips = [];
  if (x.buyerCountry) chips.push(esc(x.buyerCountry));
  if (x.procedureType) chips.push(esc(x.procedureType));
  if (x.contractType) chips.push(esc(x.contractType));
  if (x.estimatedValue) chips.push('~'+esc(x.estimatedValue)+' '+esc(x.currency||''));
  if (x.priorityScore!=='' && x.priorityScore!=null) chips.push('Score '+esc(x.priorityScore));
  return `
    <div class="card">
      <div class="title">${esc(x.title || x.reference)}</div>
      <div class="muted">${esc(x.reference || '')} ${x.contractingAuthority? '• '+esc(x.contractingAuthority):''}</div>
      <div class="muted">${dl ? 'Date limite : '+esc(dl)+ (days!=null ? ' ('+days+' j)' : '') : 'Date limite : n/a'}</div>
      <div class="kpis">${chips.map(c=>`<span class="chip">${c}</span>`).join('')}</div>
      <div class="link" style="margin-top:10px"><a href="${esc(x.noticeUrl)}" target="_blank" rel="noopener">Voir l’avis</a>${x.esubmissionLink ? ` • <a href="${esc(x.esubmissionLink)}" target="_blank" rel="noopener">Soumettre</a>`:''}</div>
    </div>`;
}

/* ====== chargement & filtrage ====== */
async function loadCSV(path){ const r = await fetch(path, {cache:'no-store'}); if(!r.ok) throw new Error(path+': '+r.status); return parseCSV(await r.text()); }

async function main(){
  document.getElementById('ts').textContent = new Date().toISOString();

  // chemins relatifs (newsletter servie depuis docs/)
  const funding = await loadCSV('funding_enriched.csv').catch(()=>[]);
  const tenders = await loadCSV('tenders_enriched.csv').catch(()=>[]);

  function render(){
    const daysWin = Number(document.getElementById('daysWindow').value || '14');
    const kw = document.getElementById('kw').value.trim();
    const kws = kw ? kw.split(',').map(s=>s.trim()).filter(Boolean) : [];
    const country = document.getElementById('country').value.trim().toLowerCase();
    const minVal = byNum(document.getElementById('minVal').value);

    // Funding : filtre par window et keywords
    let f = funding.filter(x => x.nextDeadline && withinDays(x.nextDeadline, daysWin));
    if (kws.length) f = f.filter(x => includesAnyKw(`${x.title} ${x.summaryShort} ${x.destination} ${x.workProgrammePart} ${x.typeOfAction}`, kws));
    f.sort((a,b) => (Number(b.priorityScore||0)-Number(a.priorityScore||0)) || (Number(a.daysToDeadline||9999)-Number(b.daysToDeadline||9999)));

    // Tenders : filtre par window + pays + min value
    let t = tenders.filter(x => x.deadlineDate && withinDays(x.deadlineDate, daysWin));
    if (country) t = t.filter(x => String(x.buyerCountry||'').toLowerCase().includes(country));
    if (minVal!=null) t = t.filter(x => (byNum(x.estimatedValue)||0) >= minVal);
    t.sort((a,b) => (Number(b.priorityScore||0)-Number(a.priorityScore||0)) || (Number(a.daysToDeadline||9999)-Number(b.daysToDeadline||9999)));

    // Nouveautés 7 jours (Funding + Tenders)
    const news = [
      ...funding.filter(x => x.generatedAt && thisWeek(x.generatedAt)),
      ...tenders.filter(x => x.generatedAt && thisWeek(x.generatedAt))
    ].slice(0,100); // cap visuel

    // Rendu
    const fg = document.getElementById('fundingGrid');
    const fe = document.getElementById('fundingEmpty');
    fg.innerHTML = f.map(cardFunding).join('');
    fe.hidden = f.length>0;

    const tg = document.getElementById('tendersGrid');
    const te = document.getElementById('tendersEmpty');
    tg.innerHTML = t.map(cardTender).join('');
    te.hidden = t.length>0;

    const ng = document.getElementById('newsGrid');
    const ne = document.getElementById('newsEmpty');
    // affiche une carte minimaliste (selon présence des champs)
    ng.innerHTML = news.map(x => {
      if (x.url) return cardFunding(x);
      if (x.noticeUrl) return cardTender(x);
      return '';
    }).join('');
    ne.hidden = news.length>0;
  }

  render();
  document.getElementById('apply').addEventListener('click', render);
}

main().catch(err => {
  console.error(err);
  alert('Chargement impossible : '+err.message);
});
</script>
</body>
</html>
